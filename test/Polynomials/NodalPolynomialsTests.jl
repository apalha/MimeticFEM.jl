module NodalPolynomialsTests

import MimeticFEM

import LinearAlgebra
using Test

# Lobatto-Legendre polynomials ----------------------------------------------------------
# Reference data
p_reference = [1, 2, 3, 4, 5, 20]  # polynomial degrees of reference data
ll_nodes_reference = [[-1.0, 1.0],  # p = 1
                      [-1.0, 0.0, 1.0],  # p = 2
                      [-1.0, -0.4472135954999579, 0.4472135954999579, 1.0],  # p = 3
                      [-1.0, -0.6546536707079772, 0.0, 0.6546536707079772, 1.0],  # p = 4
                      [-1.0, -0.7650553239294646, -0.2852315164806451, 0.2852315164806451, 0.7650553239294646, 1.0], # p = 5
                      [-1.0, -0.982572296604548, -0.9419762969597455, -0.8792947553235905, -0.7960019260777124, -0.6940510260622232, -0.5758319602618307, -0.4441157832790021, -0.3019898565087649, -0.15278551580218547, 0.0, 0.15278551580218547, 0.3019898565087649, 0.4441157832790021, 0.5758319602618307, 0.6940510260622232, 0.7960019260777124, 0.8792947553235905, 0.9419762969597455, 0.982572296604548, 1.0]  # p = 20
                     ]
ll_evaluation = [
                  # p = 1
                  [
                    1.000000000000  0.000000000000;
                    0.900000000000  0.100000000000;
                    0.800000000000  0.200000000000;
                    0.700000000000  0.300000000000;
                    0.600000000000  0.400000000000;
                    0.500000000000  0.500000000000;
                    0.400000000000  0.600000000000;
                    0.300000000000  0.700000000000;
                    0.200000000000  0.800000000000;
                    0.100000000000  0.900000000000;
                    0.000000000000  1.000000000000
                  ],
                  # p = 2
                  [
                    1.000000000000  0.000000000000   0.000000000000;
                    0.720000000000  0.360000000000  -0.080000000000;
                    0.480000000000  0.640000000000  -0.120000000000;
                    0.280000000000  0.840000000000  -0.120000000000;
                    0.120000000000  0.960000000000  -0.080000000000;
                    0.000000000000  1.000000000000   0.000000000000;
                    -0.080000000000  0.960000000000   0.120000000000;
                    -0.120000000000  0.840000000000   0.280000000000;
                    -0.120000000000  0.640000000000   0.480000000000;
                    -0.080000000000  0.360000000000   0.720000000000;
                    0.000000000000  0.000000000000   1.000000000000
                  ],
                  # p = 3
                  [
                    1.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    0.495000000000   0.627492235950  -0.177492235950   0.055000000000;
                    0.160000000000   0.936656314600  -0.136656314600   0.040000000000;
                   -0.035000000000   0.994574275275   0.055425724725  -0.015000000000;
                   -0.120000000000   0.868328157300   0.331671842700  -0.080000000000;
                   -0.125000000000   0.625000000000   0.625000000000  -0.125000000000;
                   -0.080000000000   0.331671842700   0.868328157300  -0.120000000000;
                   -0.015000000000   0.055425724725   0.994574275275  -0.035000000000;
                    0.040000000000  -0.136656314600   0.936656314600   0.160000000000;
                    0.055000000000  -0.177492235950   0.627492235950   0.495000000000;
                    0.000000000000   0.000000000000   0.000000000000   1.000000000000
                  ],
                  [
                    1.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    0.266400000000   0.855336358376  -0.177600000000   0.085463641624  -0.029600000000;
                    -0.057600000000   0.983648477835   0.102400000000  -0.042848477835   0.014400000000;
                    -0.131600000000   0.723492418106   0.526400000000  -0.174692418106   0.056400000000;
                    -0.081600000000   0.335024238918   0.870400000000  -0.178224238918   0.054400000000;
                    0.000000000000   0.000000000000   1.000000000000   0.000000000000   0.000000000000;
                    0.054400000000  -0.178224238918   0.870400000000   0.335024238918  -0.081600000000;
                    0.056400000000  -0.174692418106   0.526400000000   0.723492418106  -0.131600000000;
                    0.014400000000  -0.042848477835   0.102400000000   0.983648477835  -0.057600000000;
                    -0.029600000000   0.085463641624  -0.177600000000   0.855336358376   0.266400000000;
                    0.000000000000   0.000000000000   0.000000000000   0.000000000000   1.000000000000
                  ],
                  [
                    1.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    0.072180000000   0.984305830528  -0.080904304162   0.038376130191  -0.021977656557   0.008020000000;
                    -0.131840000000   0.761275497412   0.483339899109  -0.171864833362   0.092049436841  -0.032960000000;
                    -0.061460000000   0.240685165201   0.926953324275  -0.155254136393   0.075415646916  -0.026340000000;
                    0.035520000000  -0.119821892919   0.961832464341   0.168947062900  -0.070157634323   0.023680000000;
                    0.062500000000  -0.194648642354   0.632148642354   0.632148642354  -0.194648642354   0.062500000000;
                    0.023680000000  -0.070157634323   0.168947062900   0.961832464341  -0.119821892919   0.035520000000;
                    -0.026340000000   0.075415646916  -0.155254136393   0.926953324275   0.240685165201  -0.061460000000;
                    -0.032960000000   0.092049436841  -0.171864833362   0.483339899109   0.761275497412  -0.131840000000;
                    0.008020000000  -0.021977656557   0.038376130191  -0.080904304162   0.984305830528   0.072180000000;
                    0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   1.000000000000
                  ],
                  [
                    1.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    -0.004509878296   0.012230613595  -0.020962080807   0.044620528451   0.996922013488  -0.041013083031   0.020652858084  -0.013617001303   0.010036786982  -0.007862995736   0.006398912815  -0.005341228057   0.004535814641  -0.003895196820   0.003365026286  -0.002908397363   0.002497345297  -0.002106940354   0.001708472506  -0.001252667966   0.000501097588;
                    -0.011049299402   0.028600229724  -0.042643627935   0.062074939881  -0.099644098386   0.226389119194   0.938668715812  -0.152330889099   0.082186741894  -0.055759686391   0.041806599586  -0.033125689675   0.027153833902  -0.022742670602   0.019293388504  -0.016453855776   0.013990263796  -0.011719912535   0.009457415136  -0.006913842478   0.002762324850;
                    -0.011526342531   0.029388759154  -0.042103470589   0.056601045080  -0.077172516354   0.113303787401  -0.201884971587   0.842256102231   0.391029771775  -0.157837542270   0.098126010619  -0.070587462015   0.054594640771  -0.044018591297   0.036376990862  -0.030452962566   0.025552187208  -0.021205890151   0.017004088024  -0.012383494850   0.004939861085;
                    0.008854958607  -0.022409922738   0.031502274283  -0.040907469557   0.052522579493  -0.069076300701   0.096747967558  -0.155910746773   0.384908604125   0.846530720290  -0.201023990050   0.113294082455  -0.078202323801   0.059089180949  -0.046867079679   0.038171442393  -0.031429214865   0.025746654829  -0.020467973705   0.014829862626  -0.005903305738;
                    0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   1.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    -0.005903305738   0.014829862626  -0.020467973705   0.025746654829  -0.031429214865   0.038171442393  -0.046867079679   0.059089180949  -0.078202323801   0.113294082455  -0.201023990050   0.846530720290   0.384908604125  -0.155910746773   0.096747967558  -0.069076300701   0.052522579493  -0.040907469557   0.031502274283  -0.022409922738   0.008854958607;
                    0.004939861085  -0.012383494850   0.017004088024  -0.021205890151   0.025552187208  -0.030452962566   0.036376990862  -0.044018591297   0.054594640771  -0.070587462015   0.098126010619  -0.157837542270   0.391029771775   0.842256102231  -0.201884971587   0.113303787401  -0.077172516354   0.056601045080  -0.042103470589   0.029388759154  -0.011526342531;
                    0.002762324850  -0.006913842478   0.009457415136  -0.011719912535   0.013990263796  -0.016453855776   0.019293388504  -0.022742670602   0.027153833902  -0.033125689675   0.041806599586  -0.055759686391   0.082186741894  -0.152330889099   0.938668715812   0.226389119194  -0.099644098386   0.062074939881  -0.042643627935   0.028600229724  -0.011049299402;
                    0.000501097588  -0.001252667966   0.001708472506  -0.002106940354   0.002497345297  -0.002908397363   0.003365026286  -0.003895196820   0.004535814641  -0.005341228057   0.006398912815  -0.007862995736   0.010036786982  -0.013617001303   0.020652858084  -0.041013083031   0.996922013488   0.044620528451  -0.020962080807   0.012230613595  -0.004509878296;
                    0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   1.000000000000
                  ]
                  ]

# Perform the tests 
for p_idx in eachindex(p_reference)
    p = p_reference[p_idx]
    ll_polynomial = MimeticFEM.Polynomials.LobattoLegendre(p)

    # Test that nodes are generate as expected
    @test ll_polynomial.nodes ≈ ll_nodes_reference[p_idx] atol = 1e-12

    # Test if polynomial basis evaluation at nodes gives an identity matrix
    @test MimeticFEM.Polynomials.evaluate(ll_polynomial, ll_polynomial.nodes) == LinearAlgebra.Diagonal(ones(p+1))

    # Test if polynomial basis evaluation at evenly spaces nodes gives expected results
    @test MimeticFEM.Polynomials.evaluate(ll_polynomial, [range(-1.0, 1.0, length=11)...]) ≈ ll_evaluation[p_idx] atol = 1e-11
end

# ---------------------------------------------------------------------------------------

# Gauss-Lobatto-Legendre polynomials ----------------------------------------------------
p_reference = [1, 2, 3, 4, 5, 20]  # polynomial degrees of reference data
gl_nodes_reference = [[-0.5773502691896258, 0.5773502691896258],  # p = 1
                      [-0.7745966692414834, 0.0, 0.7745966692414834],  # p = 2
                      [-0.8611363115940526, -0.3399810435848563, 0.3399810435848563, 0.8611363115940526],  # p = 3
                      [-0.906179845938664, -0.5384693101056831, 0.0, 0.5384693101056831, 0.906179845938664],  # p = 4
                      [-0.932469514203152, -0.6612093864662645, -0.2386191860831969, 0.2386191860831969, 0.6612093864662645, 0.932469514203152], # p = 5
                      [-0.9937521706203895, -0.9672268385663063, -0.9200993341504008, -0.8533633645833173, -0.7684399634756779, -0.6671388041974123, -0.5516188358872198, -0.4243421202074388, -0.2880213168024011, -0.1455618541608951, 0.0, 0.1455618541608951, 0.2880213168024011, 0.4243421202074388, 0.5516188358872198, 0.6671388041974123, 0.7684399634756779, 0.8533633645833173, 0.9200993341504008, 0.9672268385663063, 0.9937521706203895]  # p = 20
                     ]
gl_evaluation = [
                  [
                    1.366025403784  -0.366025403784;
                    1.192820323028  -0.192820323028;
                    1.019615242271  -0.019615242271;
                    0.846410161514   0.153589838486;
                    0.673205080757   0.326794919243;
                    0.500000000000   0.500000000000;
                    0.326794919243   0.673205080757;
                    0.153589838486   0.846410161514;
                    -0.019615242271   1.019615242271;
                    -0.192820323028   1.192820323028;
                    -0.366025403784   1.366025403784
                  ],
                  [
                    1.478830557701  -0.666666666667   0.187836108965;
                    1.049731112828  -0.066666666667   0.016935553839;
                    0.687298334621   0.400000000000  -0.087298334621;
                    0.391532223080   0.733333333333  -0.124865556414;
                    0.162432778207   0.933333333333  -0.095766111540;
                    0.000000000000   1.000000000000   0.000000000000;
                    -0.095766111540   0.933333333333   0.162432778207;
                    -0.124865556414   0.733333333333   0.391532223080;
                    -0.087298334621   0.400000000000   0.687298334621;
                    0.016935553839  -0.066666666667   1.049731112828;
                    0.187836108965  -0.666666666667   1.478830557701
                  ],
                  [
                    1.526788125457  -0.813632449487   0.400761520312  -0.113917196282;
                    0.808023808144   0.271997468855  -0.109759712650   0.029738435651;
                    0.331253417505   0.842635636374  -0.233091124873   0.059202070994;
                    0.051953713134   1.011054749514  -0.082005412801   0.018996950154;
                    -0.074398545379   0.890027504721   0.230724727118  -0.046353686461;
                    -0.092326598441   0.592326598441   0.592326598441  -0.092326598441;
                    -0.046353686461   0.230724727118   0.890027504721  -0.074398545379;
                    0.018996950154  -0.082005412801   1.011054749514   0.051953713134;
                    0.059202070994  -0.233091124873   0.842635636374   0.331253417505;
                    0.029738435651  -0.109759712650   0.271997468855   0.808023808144;
                    -0.113917196282   0.400761520312  -0.813632449487   1.526788125457
                  ],
                  [
                    1.551408049094  -0.893158392000   0.533333333333  -0.267941652223   0.076358661796;
                    0.547669576584   0.629716298306  -0.266346666667   0.123043641487  -0.034082849710;
                    0.072562784405   1.022599653248  -0.135680000000   0.055268298927  -0.014750736580;
                    -0.077823241765   0.805689167575   0.360853333333  -0.118877859928   0.030158600785;
                    -0.063384085575   0.374527005359   0.820053333333  -0.171660345779   0.040464092662;
                    0.000000000000   0.000000000000   1.000000000000   0.000000000000   0.000000000000;
                    0.040464092662  -0.171660345779   0.820053333333   0.374527005359  -0.063384085575;
                    0.030158600785  -0.118877859928   0.360853333333   0.805689167575  -0.077823241765;
                    -0.014750736580   0.055268298927  -0.135680000000   1.022599653248   0.072562784405;
                    -0.034082849710   0.123043641487  -0.266346666667   0.629716298306   0.547669576584;
                    0.076358661796  -0.267941652223   0.533333333333  -0.893158392000   1.551408049094
                  ],
                  [
                    1.565673200151  -0.940462843176   0.616930055430  -0.379227702115   0.191800014039  -0.054712724329;
                    0.312712359065   0.899441481913  -0.327823655980   0.177190940896  -0.085431996447   0.023910870553;
                    -0.054729305749   0.895830327194   0.223688440595  -0.096392632160   0.043476702040  -0.011873531921;
                    -0.058107741475   0.356953778712   0.851753070394  -0.215240329060   0.087861715815  -0.023220494386;
                    0.011631002310  -0.055664790344   0.980032425147   0.086289099509  -0.029810548057   0.007522811435;
                    0.035433689183  -0.150585800697   0.615152111513   0.615152111513  -0.150585800697   0.035433689183;
                    0.007522811435  -0.029810548057   0.086289099509   0.980032425147  -0.055664790344   0.011631002310;
                    -0.023220494386   0.087861715815  -0.215240329060   0.851753070394   0.356953778712  -0.058107741475;
                    -0.011873531921   0.043476702040  -0.096392632160   0.223688440595   0.895830327194  -0.054729305749;
                    0.023910870553  -0.085431996447   0.177190940896  -0.327823655980   0.899441481913   0.312712359065;
                    -0.054712724329   0.191800014039  -0.379227702115   0.616930055430  -0.940462843176   1.565673200151
                  ],
                  [
                    1.598636375097  -1.053131361255   0.828553552147  -0.693484403543   0.597344751509  -0.521973379834   0.459127694004  -0.404518947167   0.355715117885  -0.311260888696   0.270260183573  -0.232159595437   0.196628408181  -0.163489175921   0.132677050028  -0.104217287098   0.078216493256  -0.054867934477   0.034478414388  -0.017544720028   0.005009653386;
                    -0.010176219311   0.040742632504  -0.108813947445   0.376175203193   0.865177760820  -0.258147278034   0.163612460054  -0.122367194203   0.097649858448  -0.080221496541   0.066687780499  -0.055522552250   0.045950061061  -0.037545225286   0.030066356145  -0.023377308237   0.017409044890  -0.012141296309   0.007597516245  -0.003855340741   0.001099184499;
                    -0.004664720272   0.017283678696  -0.038032592154   0.073808279635  -0.151012618436   0.475891159539   0.782481810831  -0.243784113313   0.149284290472  -0.107621766870   0.082832454763  -0.065598093458   0.052446394565  -0.041804978656   0.032873186618  -0.025214888277   0.018587998460  -0.012866922697   0.008008823602  -0.004049848133   0.001152465086;
                    -0.001643142131   0.005943545634  -0.012433293171   0.021909590105  -0.036671056391   0.063529587632  -0.132626155879   0.934429217205   0.220920210242  -0.102099696209   0.065996904509  -0.047617070724   0.035955796180  -0.027592898352   0.021130964000  -0.015903477602   0.011563352076  -0.007925080441   0.004898530991  -0.002465822426   0.000699994753;
                     0.002029529558  -0.007255687199   0.014827912949  -0.025103013601   0.039246914004  -0.059988366252   0.094430039879  -0.167414841913   0.464069373347   0.787958441077  -0.217948320537   0.124131167876  -0.083701256325   0.060156442075  -0.044175823050   0.032316502896  -0.023036548681   0.015570495404  -0.009532699392   0.004769216888  -0.001349479005;
                     0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   1.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000   0.000000000000;
                    -0.001349479005   0.004769216888  -0.009532699392   0.015570495404  -0.023036548681   0.032316502896  -0.044175823050   0.060156442075  -0.083701256325   0.124131167876  -0.217948320537   0.787958441077   0.464069373347  -0.167414841913   0.094430039879  -0.059988366252   0.039246914004  -0.025103013601   0.014827912949  -0.007255687199   0.002029529558;
                     0.000699994753  -0.002465822426   0.004898530991  -0.007925080441   0.011563352076  -0.015903477602   0.021130964000  -0.027592898352   0.035955796180  -0.047617070724   0.065996904509  -0.102099696209   0.220920210242   0.934429217205  -0.132626155879   0.063529587632  -0.036671056391   0.021909590105  -0.012433293171   0.005943545634  -0.001643142131;
                     0.001152465086  -0.004049848133   0.008008823602  -0.012866922697   0.018587998460  -0.025214888277   0.032873186618  -0.041804978656   0.052446394565  -0.065598093458   0.082832454763  -0.107621766870   0.149284290472  -0.243784113313   0.782481810831   0.475891159539  -0.151012618436   0.073808279635  -0.038032592154   0.017283678696  -0.004664720272;
                     0.001099184499  -0.003855340741   0.007597516245  -0.012141296309   0.017409044890  -0.023377308237   0.030066356145  -0.037545225286   0.045950061061  -0.055522552250   0.066687780499  -0.080221496541   0.097649858448  -0.122367194203   0.163612460054  -0.258147278034   0.865177760820   0.376175203193  -0.108813947445   0.040742632504  -0.010176219311;
                     0.005009653386  -0.017544720028   0.034478414388  -0.054867934477   0.078216493256  -0.104217287098   0.132677050028  -0.163489175921   0.196628408181  -0.232159595437   0.270260183573  -0.311260888696   0.355715117885  -0.404518947167   0.459127694004  -0.521973379834   0.597344751509  -0.693484403543   0.828553552147  -1.053131361255   1.598636375097
                  ]
                ]


# Test nodes
for p_idx in eachindex(p_reference)
    p = p_reference[p_idx]
    gl_polynomial = MimeticFEM.Polynomials.GaussLegendre(p)

    # Test that nodes are generate as expected
    @test gl_polynomial.nodes ≈ gl_nodes_reference[p_idx] atol = 1e-12

    # Test if polynomial basis evaluation at nodes gives an identity matrix
    @test MimeticFEM.Polynomials.evaluate(gl_polynomial, gl_polynomial.nodes) == LinearAlgebra.Diagonal(ones(p+1))

    # Test if polynomial basis evaluation at evenly spaces nodes gives expected results
    @test MimeticFEM.Polynomials.evaluate(gl_polynomial, [range(-1.0, 1.0, length=11)...]) ≈ gl_evaluation[p_idx] atol = 1e-11
end
# ---------------------------------------------------------------------------------------

end